<!--
@license
Copyright 2017 The Advanced REST client authors <arc@mulesoft.com>
Licensed under the Apache License, Version 2.0 (the "License"); you may not
use this file except in compliance with the License. You may obtain a copy of
the License at
http://www.apache.org/licenses/LICENSE-2.0
Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
License for the specific language governing permissions and limitations under
the License.
-->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../iron-form/iron-form.html">
<link rel="import" href="../paper-checkbox/paper-checkbox.html">
<link rel="import" href="../paper-button/paper-button.html">
<!--
Data export selector view for the export module.

Provides the UI to select data stores to export data from.

Fires non-bubbling `export` event when user click on "prepare data" button.

### Example
```
<export-data-selector on-export="_exportData"></export-data-selector>
```

### Styling
`<export-data-selector>` provides the following custom properties and mixins for styling:

Custom property | Description | Default
----------------|-------------|----------
`--export-data-selector` | Mixin applied to the element | `{}`
`--export-data-selector-intro` | Mixin applied to the intro message | `{}`
`--export-data-selector-prepare-intro` | Mixin applied to the info message related to prepare data action | `{}`
`--export-data-selector-checkbox` | Mixin applied to the checkboxes | `{}`
`--export-data-selector-form` | Mixin applied to the form element | `{}`
`--export-data-selector-action-button` | Mixin applied to the action button element | `{}`

@group UI Elements
@element export-data-selector
@demo demo/index.html
-->
<dom-module id="export-data-selector">
  <template>
    <style>
    :host {
      display: block;
      @apply --arc-font-body1;
      color: var(--export-data-selector-color, rgba(0, 0, 0, 0.74));
      @apply --export-data-selector;
    }

    .intro {
      font-size: 16px;
      @apply --export-data-selector-intro;
    }

    .prepare-info {
      font-size: 15px;
      margin-top: 24px;
      @apply --export-data-selector-prepare-intro;
    }

    paper-checkbox {
      margin: 12px 0px;
      @apply --export-data-selector-checkbox;
    }

    .action-button {
      color: var(--primary-color);
      @apply --export-data-selector-action-button;
    }

    form {
      @apply --layout-vertical;
      margin-bottom: 12px;
      @apply --export-data-selector-form;
    }
    </style>
    <p class="intro">Data to include in export</p>
    
    <form is="iron-form" id="form">
      <paper-checkbox name="saved" checked>Saved requests and projects</paper-checkbox>
      <paper-checkbox name="history" checked>Requests history</paper-checkbox>
      <paper-checkbox name="cookies" checked>Cookies</paper-checkbox>
      <paper-checkbox name="auth" checked>Saved passwords</paper-checkbox>
      <paper-checkbox name="history-url" checked>URLs history (autofill data)</paper-checkbox>
      <paper-checkbox name="websocket" checked>Web sockets history</paper-checkbox>
      <paper-checkbox name="headers-sets" checked>Headers sets</paper-checkbox>
      <paper-checkbox name="variables" checked>Variables data</paper-checkbox>
    </form>

    <paper-button class="action-button" raised on-tap="_prepare">Prepare data</paper-button>

    <p class="prepare-info">Depending on the data size it may take a minute</p>
  </template>
  <script>
    Polymer({
      is: 'export-data-selector',

      properties: {
        // Selected database names
        selected: Array
      },

      listeners: {
        'change': '_selectionChanged'
      },

      ready: function() {
        this._initSelected();
      },
      // Initialize the selection array
      _initSelected: function() {
        var data = [];
        var nodes = Polymer.dom(this.root).querySelectorAll('paper-checkbox');
        nodes.forEach(item => {
          if (item.checked) {
            data.push(item.name);
          }
        });
        this.set('selected', data);
      },
      // Handler for a change event. Selects / deselects datastore item
      _selectionChanged: function(e) {
        var target = Polymer.dom(e).path[0];
        if (target.checked === undefined) {
          return;
        }
        if (target.checked) {
          if (this.selected) {
            this.push('selected', target.name);
          } else {
            this.set('selected', [target.name]);
          }
          return;
        }
        var selected = this.selected || [];
        var index = selected.indexOf(target.name);
        if (index === -1) {
          return;
        }
        this.splice('selected', index, 1);
      },
      // Handles button click.
      _prepare: function() {
        this.fire('export', {
          types: this.selected
        }, {
          bubbles: false
        });
      },

      /**
       * Fired when the user requested to prepare the data.
       *
       * The event is not bubbling.
       *
       * @event export
       * @param {Array<String>} types List of data stores to export.
       */
    });
  </script>
</dom-module>
